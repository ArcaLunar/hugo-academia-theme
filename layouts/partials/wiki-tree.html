{{- $current := .current -}}
{{- $pages := .pages -}}
{{- $prefix := .prefix | default "/wiki/" -}}

{{- /* Build a map of folder URLs to their _index titles */ -}}
{{- $folderTitles := dict -}}
{{- $sectionURLs := slice -}}
{{- range site.Pages -}}
  {{- if and (hasPrefix .RelPermalink $prefix) .File -}}
    {{- if eq .File.BaseFileName "_index" -}}
      {{- $folderTitles = merge $folderTitles (dict .RelPermalink .Title) -}}
      {{- /* Collect all section URLs (folders with _index.md) */ -}}
      {{- if ne .RelPermalink $prefix -}}
        {{- $sectionURLs = $sectionURLs | append .RelPermalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $notes := slice -}}
{{- range $pages -}}
  {{- if hasPrefix .RelPermalink $prefix -}}
    {{- $notes = $notes | append . -}}
  {{- end -}}
{{- end -}}

{{- $scratch := newScratch -}}
{{- $scratch.Set "nodes" (dict "" (dict "title" "Wiki" "url" $prefix "childKeys" (slice) "pageKeys" (slice))) -}}
{{- $scratch.Set "pageStore" (dict) -}}
{{- $scratch.Set "folderTitles" $folderTitles -}}

{{- /* First, add all sections (folders with _index.md) to the tree */ -}}
{{- range $sectionURLs -}}
  {{- $rel := trim (strings.TrimPrefix $prefix .) "/" -}}
  {{- if eq $rel "" -}}{{- continue -}}{{- end -}}
  {{- $parts := split $rel "/" -}}
  
  {{- $pathSoFar := "" -}}
  {{- range $parts -}}
    {{- $pathSoFar = cond (eq $pathSoFar "") . (printf "%s/%s" $pathSoFar .) -}}
    {{- $nodes := $scratch.Get "nodes" -}}
    {{- if not (index $nodes $pathSoFar) -}}
      {{- $folderURL := printf "%s%s/" $prefix $pathSoFar -}}
      {{- $ft := $scratch.Get "folderTitles" -}}
      {{- $displayTitle := index $ft $folderURL -}}
      {{- if not $displayTitle -}}
        {{- $displayTitle = replace . "-" " " | title -}}
      {{- end -}}
      {{- $scratch.Set "nodes" (merge $nodes (dict $pathSoFar (dict "title" $displayTitle "url" $folderURL "childKeys" (slice) "pageKeys" (slice)))) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Then add all regular pages */ -}}
{{- range $i, $p := $notes -}}
  {{- $rel := trim (strings.TrimPrefix $prefix $p.RelPermalink) "/" -}}
  {{- if eq $rel "" -}}{{- continue -}}{{- end -}}
  {{- $parts := split $rel "/" -}}
  {{- $dirs := slice -}}
  {{- if gt (len $parts) 1 -}}
    {{- $dirs = first (sub (len $parts) 1) $parts -}}
  {{- end -}}

  {{- $pathSoFar := "" -}}
  {{- range $dirs -}}
    {{- $pathSoFar = cond (eq $pathSoFar "") . (printf "%s/%s" $pathSoFar .) -}}
    {{- $nodes := $scratch.Get "nodes" -}}
    {{- if not (index $nodes $pathSoFar) -}}
      {{- $folderURL := printf "%s%s/" $prefix $pathSoFar -}}
      {{- $ft := $scratch.Get "folderTitles" -}}
      {{- $displayTitle := index $ft $folderURL -}}
      {{- if not $displayTitle -}}
        {{- $displayTitle = replace . "-" " " | title -}}
      {{- end -}}
      {{- $scratch.Set "nodes" (merge $nodes (dict $pathSoFar (dict "title" $displayTitle "url" $folderURL "childKeys" (slice) "pageKeys" (slice)))) -}}
    {{- end -}}
  {{- end -}}

  {{- $parentPath := cond (gt (len $dirs) 0) (delimit $dirs "/") "" -}}
  {{- $nodes := $scratch.Get "nodes" -}}
  {{- $parent := index $nodes $parentPath -}}
  {{- $pageKey := printf "page-%d" $i -}}
  {{- $scratch.Set "pageStore" (merge ($scratch.Get "pageStore") (dict $pageKey $p)) -}}
  {{- $newPageKeys := $parent.pageKeys | default (slice) | append $pageKey -}}
  {{- $scratch.Set "nodes" (merge $nodes (dict $parentPath (merge $parent (dict "pageKeys" $newPageKeys)))) -}}
{{- end -}}

{{- /* Build parent-child relationships */ -}}
{{- $nodes := $scratch.Get "nodes" -}}
{{- range $k, $v := $nodes -}}
  {{- if eq $k "" -}}{{- continue -}}{{- end -}}
  {{- $parentPath := "" -}}
  {{- if in $k "/" -}}
    {{- $parentPath = replaceRE "/[^/]+$" "" $k -}}
  {{- end -}}
  {{- $parent := index $nodes $parentPath -}}
  {{- $newChildKeys := $parent.childKeys | default (slice) | append $k -}}
  {{- $scratch.Set "nodes" (merge ($scratch.Get "nodes") (dict $parentPath (merge $parent (dict "childKeys" $newChildKeys)))) -}}
{{- end -}}

{{- $nodes = $scratch.Get "nodes" -}}
{{- $pageStore := $scratch.Get "pageStore" -}}
{{- $root := index $nodes "" -}}

{{- /* Only render if there's content */ -}}
{{- $rootChildKeys := $root.childKeys | default (slice) -}}
{{- $rootPageKeys := $root.pageKeys | default (slice) -}}
{{- if or (gt (len $rootChildKeys) 0) (gt (len $rootPageKeys) 0) -}}
  {{- template "wiki-tree-render" (dict "node" $root "nodes" $nodes "pageStore" $pageStore "current" $current "level" 0 "prefix" $prefix) -}}
{{- else -}}
  <div class="wiki-empty">No pages found.</div>
{{- end -}}

{{- define "wiki-tree-render" -}}
  {{- $node := .node -}}
  {{- $nodes := .nodes -}}
  {{- $pageStore := .pageStore -}}
  {{- $current := .current -}}
  {{- $level := .level -}}
  {{- $prefix := .prefix -}}
  {{- $childKeys := $node.childKeys | default (slice) -}}
  {{- $pageKeys := $node.pageKeys | default (slice) -}}
  {{- if or (gt (len $childKeys) 0) (gt (len $pageKeys) 0) -}}
    <ul class="wiki-tree level-{{ $level }}">
      {{- range sort $childKeys -}}
        {{- $child := index $nodes . -}}
        {{- $isActive := eq $child.url $current.RelPermalink -}}
        {{- $isAncestor := and (not $isActive) (hasPrefix $current.RelPermalink $child.url) -}}
        {{- $hasContent := or (gt (len ($child.childKeys | default slice)) 0) (gt (len ($child.pageKeys | default slice)) 0) -}}
        <li class="{{ if $hasContent }}has-children{{ end }} {{ if $isActive }}active{{ end }} {{ if $isAncestor }}ancestor expanded{{ end }}">
          <a href="{{ $child.url }}">{{ $child.title }}</a>
          {{- template "wiki-tree-render" (dict "node" $child "nodes" $nodes "pageStore" $pageStore "current" $current "level" (add $level 1) "prefix" $prefix) -}}
        </li>
      {{- end -}}
      {{- range sort $pageKeys -}}
        {{- $p := index $pageStore . -}}
        {{- $title := cond (ne $p.Title "") $p.Title $p.File.BaseFileName -}}
        {{- $isActive := eq $p.RelPermalink $current.RelPermalink -}}
        <li class="{{ if $isActive }}active{{ end }}">
          <a href="{{ $p.RelPermalink }}">{{ $title }}</a>
        </li>
      {{- end -}}
    </ul>
  {{- end -}}
{{- end -}}
