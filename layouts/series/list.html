{{ define "main" }}
{{/* Collect all series with counts and list of series names */}}
{{ $seriesCounts := dict }}
{{ $seriesKeys := slice }}
{{ $pages := where site.RegularPages "Section" "series" | default (slice) }}
{{ range $pages }}
  {{ $seriesList := slice }}
  {{ with .Params.series }}
    {{ $kind := printf "%T" . }}
    {{ if or (eq $kind "[]string") (eq $kind "[]interface {}") }}
      {{ $seriesList = . }}
    {{ else }}
      {{ $seriesList = split (string .) "," }}
    {{ end }}
  {{ end }}
  {{ range $seriesList }}
    {{ $s := strings.TrimSpace (string .) }}
    {{ if $s }}
      {{ $count := index $seriesCounts $s | default 0 }}
      {{ $seriesCounts = merge $seriesCounts (dict $s (add $count 1)) }}
      {{ if not (in $seriesKeys $s) }}
        {{ $seriesKeys = $seriesKeys | append $s }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $seriesKeys = sort $seriesKeys }}

{{/* Determine active series term (for taxonomy pages) */}}
{{ $activeSeries := "" }}
{{ with .Data.Term }}
  {{ $activeSeries = . }}
{{ end }}

{{/* Choose which pages to show: all for section root, filtered for term */}}
{{ $sectionPages := $pages.ByDate.Reverse }}
{{ if $activeSeries }}
  {{ $sectionPages = where $pages "Params.series" "intersect" (slice $activeSeries) }}
{{ end }}

<div class="series-shell">
  {{/* Left sidebar: Split 40%/60% */}}
  <aside class="series-sidebar">
    <!-- Upper 40%: Series List -->
    <div class="series-list-container">
      <a class="series-header" href="{{ "series/" | relURL }}">
        <i class="fa-solid fa-tags"></i>
        <span>Series</span>
      </a>
      {{ if gt (len $seriesCounts) 0 }}
        <ul class="series-list">
          {{ range $seriesKeys }}
            {{ $count := index $seriesCounts . }}
            <li class="series-item {{ if eq $activeSeries . }}active{{ end }}">
              <a href="{{ "series/" | relURL }}{{ . | urlize }}/">
                <span class="series-name">{{ . }}</span>
                <span class="series-count">{{ $count }}</span>
              </a>
            </li>
          {{ end }}
        </ul>
      {{ else }}
        <p class="series-empty">No series yet.</p>
      {{ end }}
    </div>

    <!-- Lower 60%: Latest Articles List -->
    <div class="latest-articles-container">
      <div class="latest-header">
        <i class="fa-solid fa-clock"></i>
        <span>Latest</span>
      </div>
      {{ if $sectionPages }}
        <ul class="article-list-simple">
          {{ range $sectionPages }}
            <li class="article-item-simple">
              <a href="{{ .Permalink }}">
                <span class="article-title">{{ .Title }}</span>
                <span class="article-date">{{ .Date.Format "2006-01-02" }}</span>
              </a>
            </li>
          {{ end }}
        </ul>
      {{ else }}
        <p class="no-articles">No articles.</p>
      {{ end }}
    </div>
  </aside>

  {{/* Right content: Series cards (if no series selected) OR timeline (if series selected) */}}
  <section class="series-content">
    {{ if not $activeSeries }}
      <!-- Show Series Cards Overview -->
      <div class="series-cards-section">
        <h2>Series Overview</h2>
        <div class="series-cards-grid">
          {{ range $seriesKeys }}
            {{ $count := index $seriesCounts . }}
            {{ $seriesTerm := . }}
            {{ $termPages := where $pages "Params.series" "intersect" (slice $seriesTerm) }}
            {{ with index $termPages 0 }}
              {{ $seriesDesc := "" }}
              {{/* Try to get description from series taxonomy term page */}}
              {{ with site.GetPage (printf "/series/%s" ($seriesTerm | urlize)) }}
                {{ with .Params.description }}
                  {{ $seriesDesc = . }}
                {{ end }}
              {{ end }}
              <article class="series-card" data-series="{{ $seriesTerm }}">
                <a href="{{ "series/" | relURL }}{{ $seriesTerm | urlize }}/">
                  <div class="series-card-header">
                    <h3>{{ $seriesTerm }}</h3>
                    <span class="series-card-count">{{ $count }} articles</span>
                  </div>
                  {{ with $seriesDesc }}
                    <p class="series-card-desc">{{ . }}</p>
                  {{ end }}
                </a>
              </article>
            {{ end }}
          {{ end }}
        </div>
      </div>
    {{ else }}
      <!-- Show Timeline for selected series -->
      <div class="timeline-section">
        <div class="timeline-header">
          <h2>{{ $activeSeries }}</h2>
          <a href="{{ "series/" | relURL }}" class="back-to-series">
            <i class="fa-solid fa-arrow-left"></i>
            Back to all series
          </a>
        </div>
        <div class="timeline-container">
          {{ range $sectionPages }}
            <article class="timeline-item">
              <div class="timeline-date">{{ .Date.Format "2006-01-02" }}</div>
              <a href="{{ .Permalink }}" class="timeline-content">
                <span class="timeline-title">{{ .Title }}</span>
                {{ with .Params.summary }}
                  <p class="timeline-summary">{{ . }}</p>
                {{ end }}
              </a>
            </article>
          {{ end }}
        </div>
      </div>
    {{ end }}
  </section>
</div>
{{ end }}
