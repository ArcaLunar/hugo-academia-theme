{{ define "main" }}
{{ $allPages := site.RegularPages }}
{{ $prefix := "/wiki/" }}
{{ $currentPath := .RelPermalink }}

{{/* Collect all wiki pages */}}
{{ $wikiPages := slice }}
{{ range $allPages }}
  {{ if hasPrefix .RelPermalink $prefix }}
    {{ $wikiPages = $wikiPages | append . }}
  {{ end }}
{{ end }}

{{/* Build subfolders and pages for current path */}}
{{ $subfolders := dict }}
{{ $directPages := slice }}

{{ range $wikiPages }}
  {{ $rel := strings.TrimPrefix $currentPath .RelPermalink }}
  {{ if and (ne $rel "") (ne $rel .RelPermalink) }}
    {{ $parts := split (trim $rel "/") "/" }}
    {{ if eq (len $parts) 1 }}
      {{ $directPages = $directPages | append . }}
    {{ else }}
      {{ $folderSlug := index $parts 0 }}
      {{ $subfolders = merge $subfolders (dict $folderSlug true) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Get folder title from _index.md or transform slug */}}
{{ $folderTitles := dict }}
{{ range site.Pages }}
  {{ if and (hasPrefix .RelPermalink $prefix) .File }}
    {{ if eq .File.BaseFileName "_index" }}
      {{ $folderTitles = merge $folderTitles (dict .RelPermalink .Title) }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="wiki-shell">
  <aside class="wiki-tree-shell">
    {{ partial "wiki-tree.html" (dict "pages" $allPages "current" . "prefix" $prefix) }}
  </aside>

  <article class="wiki-content">
    <nav class="wiki-breadcrumb">{{ partial "wiki-breadcrumb.html" . }}</nav>
    
    <header class="wiki-header">
      <h1>{{ .Title }}</h1>
      {{ with .Params.description }}
        <p class="wiki-description">{{ . }}</p>
      {{ end }}
    </header>

    {{ with .Content }}
      <div class="wiki-intro markdown-body">{{ . }}</div>
    {{ end }}

    <div class="wiki-listing">
      {{ $folderKeys := slice }}
      {{ range $k, $v := $subfolders }}
        {{ $folderKeys = $folderKeys | append $k }}
      {{ end }}

      {{ if $folderKeys }}
        <section class="wiki-section">
          <h2 class="wiki-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            Folders
          </h2>
          <ul class="wiki-list">
            {{ range sort $folderKeys }}
              {{ $folderURL := printf "%s%s/" $currentPath . }}
              {{ $displayTitle := index $folderTitles $folderURL }}
              {{ if not $displayTitle }}
                {{ $displayTitle = replace . "-" " " | title }}
              {{ end }}
              <li class="wiki-list-item wiki-list-folder">
                <a href="{{ $folderURL }}">
                  <span class="wiki-list-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                  </span>
                  <span class="wiki-list-title">{{ $displayTitle }}</span>
                  <span class="wiki-list-arrow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                  </span>
                </a>
              </li>
            {{ end }}
          </ul>
        </section>
      {{ end }}

      {{ if $directPages }}
        <section class="wiki-section">
          <h2 class="wiki-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            Pages
          </h2>
          <ul class="wiki-list">
            {{ range sort $directPages "Title" }}
              <li class="wiki-list-item wiki-list-page">
                <a href="{{ .RelPermalink }}">
                  <span class="wiki-list-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                  </span>
                  <span class="wiki-list-title">{{ if .Title }}{{ .Title }}{{ else }}{{ .File.BaseFileName }}{{ end }}</span>
                  {{ with .Params.description }}
                    <span class="wiki-list-desc">{{ . }}</span>
                  {{ end }}
                  {{ with .Date }}
                    <span class="wiki-list-meta">{{ .Format "Jan 2, 2006" }}</span>
                  {{ end }}
                </a>
              </li>
            {{ end }}
          </ul>
        </section>
      {{ end }}

      {{ if and (not $folderKeys) (not $directPages) }}
        <p class="wiki-empty">This folder is empty.</p>
      {{ end }}
    </div>
  </article>
</div>
{{ end }}
